{% extends "base.html" %}

{% block title %}Zotero Users - Overleaf-Zotero Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-journal-bookmark"></i> Zotero User Management</h2>
        <hr>
    </div>
</div>

<!-- Instructions Card -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info">
            <h5><i class="bi bi-info-circle"></i> How to get Zotero credentials:</h5>
            <ol>
                <li>Go to <a href="https://www.zotero.org/settings/keys/new" target="_blank">Zotero API Key Settings</a>
                </li>
                <li>Set <strong>Key Name</strong> to any descriptive name</li>
                <li>Select <strong>Personal Library: Read Only</strong></li>
                <li>Click <strong>Save Key</strong></li>
                <li>Copy the <strong>API Key</strong> and <strong>User ID</strong></li>
            </ol>
        </div>
    </div>
</div>

<!-- Add User Button -->
<div class="row mb-3">
    <div class="col-12">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="bi bi-plus-circle"></i> Add New User
        </button>
        <button class="btn btn-secondary" onclick="refreshUserList()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>
</div>

<!-- Users Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="usersTable">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Container</th>
                                <th>Status</th>
                                <th>Internal URL</th>
                                <th style="min-width: 200px;">API Key</th>
                                <th>User ID</th>
                                <th>Port</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Zotero User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addUserForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="userUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="userUsername" required pattern="[a-z0-9-]+"
                            placeholder="lowercase-only">
                        <small class="text-muted">Lowercase letters, numbers, and hyphens only</small>
                    </div>
                    <div class="mb-3">
                        <label for="userApiKey" class="form-label">Zotero API Key</label>
                        <input type="text" class="form-control" id="userApiKey" required>
                    </div>
                    <div class="mb-3">
                        <label for="userUserId" class="form-label">Zotero User ID</label>
                        <input type="text" class="form-control" id="userUserId" required>
                        <small class="text-muted">Numeric ID from Zotero settings page</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus-circle"></i> Create User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Update User Modal -->
<div class="modal fade" id="updateUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Zotero User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateUserForm">
                <div class="modal-body">
                    <input type="hidden" id="updateUserUsername">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <p id="updateUserName"></p>
                    </div>
                    <div class="mb-3">
                        <label for="updateApiKey" class="form-label">New API Key</label>
                        <input type="text" class="form-control" id="updateApiKey" required>
                    </div>
                    <div class="mb-3">
                        <label for="updateUserId" class="form-label">New User ID</label>
                        <input type="text" class="form-control" id="updateUserId" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Update User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load users on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadUsers();
    });

    // Add user form submission
    document.getElementById('addUserForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const data = {
            username: document.getElementById('userUsername').value.toLowerCase(),
            api_key: document.getElementById('userApiKey').value,
            user_id: document.getElementById('userUserId').value
        };

        fetch('/api/zotero/proxies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`User created successfully!\nInternal URL: ${data.internal_url}`);
                    bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                    document.getElementById('addUserForm').reset();
                    loadUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            });
    });

    // Update user form submission
    document.getElementById('updateUserForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const username = document.getElementById('updateUserUsername').value;
        const data = {
            api_key: document.getElementById('updateApiKey').value,
            user_id: document.getElementById('updateUserId').value
        };

        fetch(`/api/zotero/proxies/${username}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User updated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('updateUserModal')).hide();
                    loadUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            });
    });

    function loadUsers() {
        fetch('/api/zotero/proxies')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayUsers(data.proxies);
                } else {
                    document.getElementById('usersTableBody').innerHTML =
                        '<tr><td colspan="8" class="text-center text-danger">Failed to load users</td></tr>';
                }
            });
    }

    function displayUsers(users) {
        const tbody = document.getElementById('usersTableBody');

        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">No users configured</td></tr>';
            return;
        }

        let html = '';
        users.forEach(user => {
            const statusBadge = user.status === 'running' ?
                '<span class="badge bg-success">Running</span>' :
                '<span class="badge bg-danger">Stopped</span>';

            html += `
            <tr>
                <td>${user.username}</td>
                <td>${user.container_name}</td>
                <td>${statusBadge}</td>
                <td>
                    <code style="font-size: 0.85em;">${user.internal_url}</code>
                </td>
                <td>
                    <div style="max-width: 300px; overflow-x: auto;">
                        <code style="font-size: 0.75em; white-space: nowrap;">${user.api_key || 'Not set'}</code>
                    </div>
                </td>
                <td>${user.user_id}</td>
                <td>${user.port || 'N/A'}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-info" onclick="copyUrl('${user.internal_url}')" title="Copy URL">
                            <i class="bi bi-clipboard"></i>
                        </button>
                        <button class="btn btn-warning" onclick="showUpdateUser('${user.username}')" title="Update Credentials">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteUser('${user.username}')" title="Delete User">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        });

        tbody.innerHTML = html;
    }

    function copyUrl(url) {
        navigator.clipboard.writeText(url).then(() => {
            alert('URL copied to clipboard!');
        });
    }

    function showUpdateUser(username) {
        document.getElementById('updateUserUsername').value = username;
        document.getElementById('updateUserName').textContent = username;
        const modal = new bootstrap.Modal(document.getElementById('updateUserModal'));
        modal.show();
    }

    function deleteUser(username) {
        if (!confirm(`Are you sure you want to delete user ${username}? This action cannot be undone.`)) return;

        fetch(`/api/zotero/proxies/${username}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User deleted successfully');
                    loadUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            });
    }

    function refreshUserList() {
        loadUsers();
    }
</script>
{% endblock %}